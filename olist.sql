USE OLIST_DATA;

SELECT *FROM CUSTOMERS;
SELECT *FROM GEOLOCATION;
SELECT *FROM ORDERITEMS;
SELECT *FROM ORDERS;
SELECT *FROM PRODUCTS;

#PRODUCT METRICS
-- WHAT IS THE TOTAL REVENUE GENERATED BY EACH PRODUCT?
SELECT PRODUCT_ID,SUM(PRICE) AS TOTAL_SALES
 FROM ORDERITEMS
 GROUP BY PRODUCT_ID;
 
 -- WHAT IS THE TOTAL QUANTITY SOLD FOR EACH PRODUCT?
 SELECT PRODUCT_ID,COUNT(ORDER_ITEM_ID) AS TOTAL_UNITS_SOLD
 FROM ORDERITEMS
 GROUP BY PRODUCT_ID;
 
 -- Which products generate high revenue but low units sold, and which generate high units sold but low revenue?
 SELECT PRODUCT_ID,
 COUNT(ORDER_ITEM_ID) AS TOTAL_UNITS,
 SUM(PRICE) AS TOTAL_REVENUE,
 ROUND(SUM(PRICE)/COUNT(ORDER_ITEM_ID),2) AS REVENUE_PER_UNIT
 FROM ORDERITEMS
 GROUP BY PRODUCT_ID
 ORDER BY REVENUE_PER_UNIT DESC;
 
 -- Which products are trending up or down over time?
 SELECT OI.PRODUCT_ID,
 YEAR(O.ORDER_PURCHASE_TIMESTAMP) AS year,
 MONTH(O.ORDER_PURCHASE_TIMESTAMP) AS MONTH,
 COUNT(OI.ORDER_ITEM_ID) AS UNITS_SOLD
 FROM ORDERITEMS OI
 JOIN 
 ORDERS O ON
 OI.ORDER_ID=O.ORDER_ID
 GROUP BY
 OI.PRODUCT_ID,
 YEAR(O.ORDER_PURCHASE_TIMESTAMP),
 MONTH(O.ORDER_PURCHASE_TIMESTAMP)
 ORDER BY
 OI.PRODUCT_ID,
 year,month;
 
 #Product names for product id
 CREATE OR REPLACE VIEW revenue_per_product AS
SELECT oi.product_id, p.product_name,
       SUM(oi.price + oi.freight_value) AS revenue
FROM orderitems oi
JOIN products p ON oi.product_id = p.product_id
JOIN orders o ON oi.order_id = o.order_id
WHERE o.order_status='delivered'
GROUP BY oi.product_id, p.product_name;

 #Customer Metrics
 -- How much money has each customer spent in total?
SELECT O.CUSTOMER_ID,SUM(OI.PRICE) AS REVENUE_PER_ORDER
FROM ORDERITEMS OI
JOIN 
ORDERS O
ON O.ORDER_ID=OI.ORDER_ID
GROUP BY O.CUSTOMER_ID;

-- How many orders has each customer placed?
SELECT CUSTOMER_ID, COUNT(ORDER_ID) AS TOTAL_ORDERS
FROM ORDERS
GROUP BY CUSTOMER_ID;

-- AVERAGE ORDER VALUE(AOV) PER CUSTOMER
SELECT O.CUSTOMER_ID,
ROUND(SUM(OI.PRICE)/COUNT(O.ORDER_ID)) AS AVERAGE_ORDER_VALUE
FROM ORDERS O
JOIN 
ORDERITEMS OI
ON OI.ORDER_ID=O.ORDER_ID
GROUP BY O.CUSTOMER_ID;

# Sales & revenue Metrics
-- How many orders and how much revenue did each customer generate per month?
SELECT 
YEAR(O.ORDER_PURCHASE_TIMESTAMP) AS year,
MONTH(O.ORDER_PURCHASE_TIMESTAMP) AS month,
  COUNT(DISTINCT O.ORDER_ID) AS TOTAL_ORDERS,
  SUM(OI.PRICE) AS TOTAL_REVENUE
  FROM ORDERS O 
  JOIN ORDERITEMS OI
  ON OI.ORDER_ID=O.ORDER_ID
  GROUP BY year,month;
  
-- Is revenue growing or declining month-over-month?
WITH monthly_revenue AS(
SELECT 
YEAR(O.ORDER_PURCHASE_TIMESTAMP) AS year,
MONTH(O.ORDER_PURCHASE_TIMESTAMP) AS month,
  COUNT(DISTINCT O.ORDER_ID) AS TOTAL_ORDERS,
  SUM(OI.PRICE) AS TOTAL_REVENUE
  FROM ORDERS O 
  JOIN ORDERITEMS OI
  ON OI.ORDER_ID=O.ORDER_ID
  GROUP BY year,month
)
SELECT 
      year,
      month,
      TOTAL_REVENUE,
LAG(TOTAL_REVENUE) OVER (ORDER BY year,month) AS PREV_MONTH_REVENUE,
ROUND(
      (TOTAL_REVENUE-LAG(TOTAL_REVENUE) OVER (ORDER BY year,month))
       /LAG(TOTAL_REVENUE) OVER (ORDER BY year,month)*100,
       2
       ) AS REVENUE_GROWTH_PERCENTAGE
       FROM MONTHLY_REVENUE
       ORDER BY year,month;
	
-- Total Revenue (Delivered Orders Only).
SELECT O.CUSTOMER_ID,O.ORDER_STATUS,SUM(OI.PRICE) AS TOTAL_REVENUE
FROM ORDERS O
JOIN ORDERITEMS OI
ON O.ORDER_ID=OI.ORDER_ID
WHERE O.ORDER_STATUS='delivered'
GROUP BY O.CUSTOMER_ID;

-- Out of all orders placed, what percentage failed to complete because they were cancelled or became unavailable?
SELECT ROUND(
     COUNT(*)*100.0/(SELECT COUNT(*) FROM ORDERS),2) AS CANCELLATION_RATE_PERCENTAGE
FROM ORDERS
WHERE ORDER_STATUS in ('cancelled','unavailable');

-- How much potential revenue did the business lose because orders were cancelled or never delivered?
 SELECT SUM(OI.PRICE) AS REVENUE_LOSS
 FROM ORDERS O
 JOIN ORDERITEMS OI
 ON O.ORDER_ID=OI.ORDER_ID
 WHERE ORDER_STATUS in ('cancelled','unavailable');
 
 -- As sales change month by month, are cancellations increasing, decreasing, or moving independently of revenue?
 SELECT YEAR(O.ORDER_PURCHASE_TIMESTAMP) AS YEAR,
        MONTH(O.ORDER_PURCHASE_TIMESTAMP) AS MONTH,
        SUM(CASE WHEN O.ORDER_STATUS='delivered' THEN OI.PRICE ELSE 0 END) AS REVENUE,
        SUM(CASE WHEN O.ORDER_STATUS in ('cancelled','unavailable') THEN OI.PRICE ELSE 0 END) AS REVENUE_LOST,
        ROUND(
        SUM(CASE WHEN O.ORDER_STATUS in ('cancelled','unavailable') THEN 1 ELSE 0 END)*100.0/COUNT(*),2) AS CANCELATION_RATE_PERCENT
        FROM ORDERS O
        JOIN ORDERITEMS OI
        ON O.ORDER_ID=OI.ORDER_ID
        GROUP BY YEAR,MONTH
        ORDER BY YEAR,MONTH;